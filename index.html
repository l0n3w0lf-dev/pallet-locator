<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pallet Locator</title>
<style>
  :root{
    --bg:#f3f5f7;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow:0 10px 25px rgba(0,0,0,.06);
    --accent:#2563eb;         /* soft blue */
    --accentBg:#eff6ff;
    --warn:#b45309;           /* amber */
    --warnBg:#fffbeb;
    --danger:#b91c1c;         /* red */
    --dangerBg:#fef2f2;
    --radius:14px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  .wrap{max-width:980px;margin:44px auto;padding:0 18px}
  header{
    display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
    margin-bottom:16px;
  }
  h1{margin:0;font-size:28px;font-weight:700;letter-spacing:.2px}
  .sub{margin:6px 0 0;color:var(--muted);line-height:1.35;max-width:70ch}
  .badge{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border:1px solid var(--border);border-radius:999px;
    background:rgba(255,255,255,.7);
    box-shadow:0 6px 16px rgba(0,0,0,.05);
    font-size:13px;color:var(--muted);white-space:nowrap;
  }
  .dot{width:9px;height:9px;border-radius:50%}
  .dot.ok{background:#16a34a}
  .dot.bad{background:#dc2626}
  .dot.wait{background:#9ca3af}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .controls{
    padding:16px;
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
  }

  .input{
    flex:1 1 320px;
    min-width:240px;
    padding:12px 14px;
    border:1px solid var(--border);
    border-radius:12px;
    font-size:16px;
    outline:none;
    background:#fff;
  }
  .input:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(37,99,235,.10)}
  .btn{
    padding:12px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    font-weight:600;
  }
  .btn:hover{background:#fafafa}

  .row{
    padding:0 16px 14px;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    color:var(--muted);
    font-size:13px;
  }

  .notice{
    margin:0 16px 16px;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fafafa;
    color:var(--muted);
    font-size:14px;
    line-height:1.35;
  }
  .notice strong{color:var(--text)}
  .notice.warn{border-color:#fcd34d;background:var(--warnBg);color:#7c2d12}
  .notice.danger{border-color:#fecaca;background:var(--dangerBg);color:#7f1d1d}

  .results{
    padding:0 16px 18px;
  }
  .sectionTitle{
    margin:18px 0 10px;
    font-size:14px;
    font-weight:700;
    color:#111827;
  }

  .list{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }
  .item{
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    background:#fff;
  }
  .itemTop{
    display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
    margin-bottom:6px;
  }
  .pallet{
    font-weight:750;
    font-size:15px;
  }
  .pill{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--accentBg);
    color:#1e40af;
    white-space:nowrap;
  }
  .meta{
    color:var(--muted);
    font-size:13px;
    display:flex;
    flex-wrap:wrap;
    gap:10px 16px;
    line-height:1.35;
  }
  .meta b{color:#111827}

  .dupPill{
    background:var(--dangerBg);
    border-color:#fecaca;
    color:#991b1b;
  }

  footer{
    text-align:center;
    margin-top:18px;
    color:#9ca3af;
    font-size:13px;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Pallet Locator</h1>
      <p class="sub">
        Type a pallet ID/name to find where it is. The sheet refreshes automatically every <strong>5 seconds</strong>.
        If the same pallet appears in multiple places, it will be flagged as a <strong>duplicate</strong>.
      </p>
    </div>
    <div class="badge" title="Data status">
      <span class="dot wait" id="dot"></span>
      <span id="status">Loading…</span>
    </div>
  </header>

  <div class="card">
    <div class="controls">
      <input id="q" class="input" placeholder="Search pallet (e.g. PAL12345)..." autocomplete="off" />
      <button id="refresh" class="btn" type="button">Refresh now</button>
    </div>

    <div class="row">
      <div id="metaLeft">—</div>
      <div>Auto refresh: every 5s</div>
    </div>

    <div id="notice" class="notice">
      Type a pallet to search.
    </div>

    <div class="results">
      <div class="sectionTitle">Results</div>
      <div class="list" id="list"></div>
    </div>
  </div>

  <footer>Made by rozimnic.</footer>
</div>

<script>
  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRx6iH6_NCeeLOFF_FqLqMf-OPW2WqNpwV19Ti_xLA-RcHyKkYaQk4X0Xz1CJ8JvA/pub?output=csv";

  const dot = document.getElementById("dot");
  const statusEl = document.getElementById("status");
  const metaLeft = document.getElementById("metaLeft");
  const notice = document.getElementById("notice");
  const list = document.getElementById("list");
  const input = document.getElementById("q");
  const refreshBtn = document.getElementById("refresh");

  let headers = [];
  let rows = [];
  let lastLoadedAt = null;

  function setStatus(kind, text){
    statusEl.textContent = text;
    dot.className = "dot " + (kind || "wait");
  }

  // Robust-ish CSV parser (handles commas + quotes)
  function parseCSV(text){
    const out = [];
    let row = [], cur = "", inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const c = text[i], n = text[i+1];

      if (c === '"' && inQuotes && n === '"'){ cur += '"'; i++; continue; }
      if (c === '"'){ inQuotes = !inQuotes; continue; }

      if (c === "," && !inQuotes){ row.push(cur); cur=""; continue; }

      if ((c === "\n" || c === "\r") && !inQuotes){
        if (c === "\r" && n === "\n") i++;
        row.push(cur); cur="";
        out.push(row);
        row = [];
        continue;
      }
      cur += c;
    }
    row.push(cur);
    out.push(row);
    // Remove trailing empty lines
    return out.filter(r => r.some(cell => (cell ?? "").toString().trim() !== ""));
  }

  function fmtTime(d){
    return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
  }

  async function loadSheet(){
    setStatus("wait", "Refreshing…");
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`Fetch failed (${res.status})`);

    const csv = await res.text();
    const grid = parseCSV(csv);

    headers = (grid[0] || []).map(h => (h ?? "").toString().trim());
    rows = grid.slice(1);

    lastLoadedAt = new Date();
    metaLeft.textContent = `Rows: ${rows.length.toLocaleString()} • Columns: ${headers.length.toLocaleString()} • Last update: ${fmtTime(lastLoadedAt)}`;

    setStatus("ok", "Up to date");
  }

  function normalize(s){
    return (s ?? "").toString().trim();
  }

  function findAllMatches(query){
    const q = normalize(query).toLowerCase();
    if (!q) return [];

    const matches = [];
    for (let r = 0; r < rows.length; r++){
      const row = rows[r];
      for (let c = 0; c < headers.length; c++){
        const cell = normalize(row[c]);
        if (!cell) continue;
        if (cell.toLowerCase().includes(q)){
          matches.push({
            pallet: cell,
            columnHeader: headers[c] || `Column ${c+1}`,
            rowNumber: r + 2
          });
        }
      }
    }
    return matches;
  }

  function countDuplicates(matches){
    // duplicates by exact pallet text (case-insensitive)
    const map = new Map();
    for (const m of matches){
      const key = m.pallet.toLowerCase();
      map.set(key, (map.get(key) || 0) + 1);
    }
    return map; // palletLower -> count
  }

  function render(){
    const q = input.value;
    list.innerHTML = "";

    const trimmed = normalize(q);
    if (!trimmed){
      notice.className = "notice";
      notice.innerHTML = "Type a pallet to search.";
      return;
    }

    const matches = findAllMatches(trimmed);
    const dupCounts = countDuplicates(matches);

    if (matches.length === 0){
      notice.className = "notice";
      notice.innerHTML = `<strong>No match</strong> for “${escapeHtml(trimmed)}”.`;
      return;
    }

    // If any duplicates exist among matches (same pallet value found > 1 times)
    const hasDup = [...dupCounts.values()].some(v => v > 1);

    if (hasDup){
      notice.className = "notice danger";
      notice.innerHTML = `<strong>Duplicate detected.</strong> The same pallet appears in multiple locations. Check results below.`;
    } else {
      notice.className = "notice warn";
      notice.innerHTML = `<strong>${matches.length}</strong> match(es) found for “${escapeHtml(trimmed)}”.`;
    }

    // Sort: duplicates first, then by column, then by row
    matches.sort((a,b) => {
      const da = dupCounts.get(a.pallet.toLowerCase()) || 0;
      const db = dupCounts.get(b.pallet.toLowerCase()) || 0;
      if (da !== db) return db - da;
      if (a.columnHeader !== b.columnHeader) return a.columnHeader.localeCompare(b.columnHeader);
      return a.rowNumber - b.rowNumber;
    });

    for (const m of matches.slice(0, 60)){
      const dupN = dupCounts.get(m.pallet.toLowerCase()) || 0;
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div class="pallet">${escapeHtml(m.pallet)}</div>
          <div class="pill ${dupN > 1 ? "dupPill" : ""}">
            ${dupN > 1 ? `Duplicate (${dupN})` : "Match"}
          </div>
        </div>
        <div class="meta">
          <span><b>Located in:</b> ${escapeHtml(m.columnHeader)}</span>
          <span><b>Sheet row:</b> ${m.rowNumber}</span>
        </div>
      `;
      list.appendChild(item);
    }

    if (matches.length > 60){
      const more = document.createElement("div");
      more.className = "notice";
      more.textContent = `Showing first 60 results. Narrow your search to see fewer matches.`;
      list.appendChild(more);
    }
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // Auto refresh every 5 seconds, and re-render after refresh
  async function refreshLoop(){
    try{
      await loadSheet();
      render();
    }catch(e){
      setStatus("bad", "Refresh failed");
      notice.className = "notice danger";
      notice.innerHTML =
        `<strong>Can’t load sheet.</strong> ${escapeHtml(e.message)}<br/>
         If you opened this page as <b>file://</b>, use a local server (VS Code Live Server).`;
    }
  }

  input.addEventListener("input", render);
  refreshBtn.addEventListener("click", refreshLoop);

  // Start
  (async () => {
    await refreshLoop();
    setInterval(refreshLoop, 5000);
  })();
</script>
</body>
</html>
