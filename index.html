<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pallet Locator</title>
<style>
  :root{
    --bg:#f4f6f8;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --muted2:#9ca3af;
    --border:#e5e7eb;
    --shadow:0 14px 30px rgba(17,24,39,.08);
    --shadow2:0 8px 18px rgba(17,24,39,.06);
    --accent:#2563eb;
    --accentBg:#eef2ff;
    --danger:#b91c1c;
    --dangerBg:#fef2f2;
    --warn:#92400e;
    --warnBg:#fffbeb;
    --radius:16px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  .wrap{max-width:980px;margin:44px auto;padding:0 18px}
  header{
    display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
    margin-bottom:18px;
  }
  h1{margin:0;font-size:30px;font-weight:750;letter-spacing:.2px}
  .sub{margin:6px 0 0;color:var(--muted);line-height:1.45;max-width:72ch}
  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border:1px solid var(--border);border-radius:999px;
    background:rgba(255,255,255,.75);
    box-shadow:var(--shadow2);
    font-size:13px;color:var(--muted);
    white-space:nowrap;
  }
  .dot{width:9px;height:9px;border-radius:50%}
  .dot.ok{background:#16a34a}
  .dot.bad{background:#dc2626}
  .dot.wait{background:#9ca3af}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  .controls{
    padding:18px;
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
  }

  .searchWrap{flex:1 1 420px;min-width:260px;position:relative}
  .input{
    width:100%;
    padding:13px 44px 13px 14px;
    border:1px solid var(--border);
    border-radius:14px;
    font-size:16px;
    outline:none;
    background:#fff;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .input:focus{
    border-color:#c7d2fe;
    box-shadow:0 0 0 4px rgba(37,99,235,.12);
  }
  .kbdHint{
    position:absolute;right:10px;top:50%;transform:translateY(-50%);
    font-size:12px;color:var(--muted2);
    border:1px solid var(--border);
    background:#fafafa;
    padding:4px 8px;border-radius:10px;
    user-select:none;
  }

  .btn{
    padding:12px 14px;
    border-radius:14px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    font-weight:650;
    transition: transform .06s ease, background .15s ease;
  }
  .btn:hover{background:#fafafa}
  .btn:active{transform:translateY(1px)}
  .btn.primary{
    background:var(--accent);
    border-color:var(--accent);
    color:#fff;
  }
  .btn.primary:hover{filter:brightness(.98)}
  .btn:disabled{
    opacity:.55;
    cursor:not-allowed;
  }

  .metaRow{
    padding:0 18px 16px;
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:10px;
    color:var(--muted);
    font-size:13px;
  }

  .notice{
    margin:0 18px 18px;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--border);
    background:#fafafa;
    color:var(--muted);
    line-height:1.4;
    font-size:14px;
  }
  .notice strong{color:var(--text)}
  .notice.warn{border-color:#fde68a;background:var(--warnBg);color:#7c2d12}
  .notice.danger{border-color:#fecaca;background:var(--dangerBg);color:#7f1d1d}

  .results{padding:0 18px 20px}
  .title{
    margin:18px 0 10px;
    font-size:14px;
    font-weight:750;
    color:#111827;
  }

  .list{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  @media (min-width: 860px){
    .list{grid-template-columns: 1fr 1fr;}
  }

  .item{
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    background:#fff;
  }
  .itemTop{
    display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
    margin-bottom:6px;
  }
  .pallet{
    font-weight:800;
    font-size:15px;
    word-break:break-word;
  }
  .pill{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--accentBg);
    color:#1e40af;
    white-space:nowrap;
  }
  .pill.dup{
    background:var(--dangerBg);
    border-color:#fecaca;
    color:#991b1b;
  }

  .meta{
    color:var(--muted);
    font-size:13px;
    display:flex;
    flex-wrap:wrap;
    gap:10px 16px;
    line-height:1.35;
  }
  .meta b{color:#111827}

  footer{
    text-align:center;
    margin-top:18px;
    color:#9ca3af;
    font-size:13px;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Pallet Locator</h1>
      <p class="sub">
        Search pallets across locations (dock / receive / p2 / p3 / p4).<br>
        Search starts only when you type <strong>more than 5 characters</strong>.
      </p>
    </div>
    <div class="chip" title="Data status">
      <span class="dot wait" id="dot"></span>
      <span id="status">Not loaded</span>
    </div>
  </header>

  <div class="card">
    <div class="controls">
      <div class="searchWrap">
        <input id="q" class="input" placeholder="Enter pallet ID/name (6+ chars)..." autocomplete="off" />
        <div class="kbdHint">Enter</div>
      </div>
      <button id="loadBtn" class="btn" type="button">Load data</button>
      <button id="searchBtn" class="btn primary" type="button" disabled>Search</button>
    </div>

    <div class="metaRow">
      <div id="metaLeft">Rows: — • Columns: —</div>
      <div id="metaRight">No auto-refresh</div>
    </div>

    <div id="notice" class="notice">
      Click <strong>Load data</strong> first. Then type a pallet (6+ chars) and press <strong>Enter</strong>.
    </div>

    <div class="results">
      <div class="title">Results</div>
      <div class="list" id="list"></div>
    </div>
  </div>

  <footer>Made by rozimnic.</footer>
</div>

<script>
  // Full published CSV link
  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRx6iH6_NCeeLOFF_FqLqMf-OPW2WqNpwV19Ti_xLA-RcHyKkYaQk4X0Xz1CJ8JvA/pub?output=csv";

  const MIN_LEN = 6; // "higher then 5 strings" => 6+ chars

  const dot = document.getElementById("dot");
  const statusEl = document.getElementById("status");
  const metaLeft = document.getElementById("metaLeft");
  const notice = document.getElementById("notice");
  const list = document.getElementById("list");
  const input = document.getElementById("q");
  const loadBtn = document.getElementById("loadBtn");
  const searchBtn = document.getElementById("searchBtn");

  let headers = [];
  let rows = [];
  let loaded = false;
  let lastLoadedAt = null;

  function setStatus(kind, text){
    statusEl.textContent = text;
    dot.className = "dot " + (kind || "wait");
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function fmtTime(d){
    return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }

  // Robust-ish CSV parser (quotes + commas)
  function parseCSV(text){
    const out = [];
    let row = [], cur = "", inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const c = text[i], n = text[i+1];

      if (c === '"' && inQuotes && n === '"'){ cur += '"'; i++; continue; }
      if (c === '"'){ inQuotes = !inQuotes; continue; }

      if (c === "," && !inQuotes){ row.push(cur); cur=""; continue; }

      if ((c === "\n" || c === "\r") && !inQuotes){
        if (c === "\r" && n === "\n") i++;
        row.push(cur); cur="";
        out.push(row);
        row = [];
        continue;
      }
      cur += c;
    }
    row.push(cur);
    out.push(row);

    return out.filter(r => r.some(cell => (cell ?? "").toString().trim() !== ""));
  }

  function normalize(s){ return (s ?? "").toString().trim(); }

  async function loadSheet(){
    setStatus("wait", "Loading…");
    notice.className = "notice";
    notice.innerHTML = "Loading data from sheet…";
    list.innerHTML = "";

    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`Fetch failed (${res.status})`);

    const csv = await res.text();
    const grid = parseCSV(csv);

    headers = (grid[0] || []).map(h => normalize(h));
    rows = grid.slice(1);

    loaded = true;
    lastLoadedAt = new Date();

    metaLeft.textContent =
      `Rows: ${rows.length.toLocaleString()} • Columns: ${headers.length.toLocaleString()} • Loaded: ${fmtTime(lastLoadedAt)}`;
    setStatus("ok", "Loaded");
    updateSearchButton();

    notice.className = "notice";
    notice.innerHTML = `Data loaded. Type a pallet (6+ chars) and press <strong>Enter</strong> or click <strong>Search</strong>.`;
  }

  function updateSearchButton(){
    const q = normalize(input.value);
    searchBtn.disabled = !(loaded && q.length >= MIN_LEN);
  }

  function findMatches(query){
    const q = normalize(query);
    const qLower = q.toLowerCase();
    if (!q || q.length < MIN_LEN) return [];

    const matches = [];
    for (let r = 0; r < rows.length; r++){
      const row = rows[r];
      for (let c = 0; c < headers.length; c++){
        const cell = normalize(row[c]);
        if (!cell) continue;

        // Partial match search (keeps UX forgiving). If you want exact only, I’ll change it.
        if (cell.toLowerCase().includes(qLower)){
          matches.push({
            pallet: cell,
            columnHeader: headers[c] || `Column ${c+1}`,
            rowNumber: r + 2
          });
        }
      }
    }
    return matches;
  }

  function duplicateCounts(matches){
    const map = new Map();
    for (const m of matches){
      const key = m.pallet.toLowerCase();
      map.set(key, (map.get(key) || 0) + 1);
    }
    return map;
  }

  function render(){
    list.innerHTML = "";

    if (!loaded){
      notice.className = "notice";
      notice.innerHTML = `Click <strong>Load data</strong> first.`;
      return;
    }

    const q = normalize(input.value);

    if (q.length < MIN_LEN){
      notice.className = "notice";
      notice.innerHTML =
        `Type at least <strong>${MIN_LEN}</strong> characters to search. ` +
        `<span style="color:var(--muted)">(${q.length}/${MIN_LEN})</span>`;
      return;
    }

    const matches = findMatches(q);
    const dups = duplicateCounts(matches);
    const hasDup = [...dups.values()].some(v => v > 1);

    if (matches.length === 0){
      notice.className = "notice";
      notice.innerHTML = `<strong>No match</strong> for “${escapeHtml(q)}”.`;
      return;
    }

    if (hasDup){
      notice.className = "notice danger";
      notice.innerHTML = `<strong>Duplicate detected.</strong> The same pallet appears in multiple locations.`;
    } else {
      notice.className = "notice warn";
      notice.innerHTML = `<strong>${matches.length}</strong> match(es) found for “${escapeHtml(q)}”.`;
    }

    // Sort duplicates first
    matches.sort((a,b)=>{
      const da = dups.get(a.pallet.toLowerCase()) || 0;
      const db = dups.get(b.pallet.toLowerCase()) || 0;
      if (da !== db) return db - da;
      if (a.columnHeader !== b.columnHeader) return a.columnHeader.localeCompare(b.columnHeader);
      return a.rowNumber - b.rowNumber;
    });

    for (const m of matches.slice(0, 80)){
      const dupN = dups.get(m.pallet.toLowerCase()) || 0;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemTop">
          <div class="pallet">${escapeHtml(m.pallet)}</div>
          <div class="pill ${dupN > 1 ? "dup" : ""}">
            ${dupN > 1 ? `Duplicate (${dupN})` : "Match"}
          </div>
        </div>
        <div class="meta">
          <span><b>Located in:</b> ${escapeHtml(m.columnHeader)}</span>
          <span><b>Sheet row:</b> ${m.rowNumber}</span>
        </div>
      `;
      list.appendChild(el);
    }

    if (matches.length > 80){
      const more = document.createElement("div");
      more.className = "notice";
      more.textContent = `Showing first 80 results. Narrow your search to see fewer matches.`;
      list.appendChild(more);
    }
  }

  // Events
  loadBtn.addEventListener("click", async () => {
    try{
      await loadSheet();
    }catch(e){
      setStatus("bad", "Load failed");
      notice.className = "notice danger";
      notice.innerHTML =
        `<strong>Can’t load sheet.</strong> ${escapeHtml(e.message)}<br>` +
        `Tip: open this page on <strong>http://localhost</strong> (VS Code Live Server).`;
    }
  });

  input.addEventListener("input", () => {
    updateSearchButton();
    // Don’t auto-search; UX is calmer. (User hits Enter or clicks Search.)
    if (!loaded) return;
    const q = normalize(input.value);
    if (q.length < MIN_LEN){
      list.innerHTML = "";
      notice.className = "notice";
      notice.innerHTML = `Type at least <strong>${MIN_LEN}</strong> characters to search. <span style="color:var(--muted)">(${q.length}/${MIN_LEN})</span>`;
    }
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      if (!searchBtn.disabled) render();
    }
  });

  searchBtn.addEventListener("click", render);

  // Initial state
  setStatus("wait", "Not loaded");
  updateSearchButton();
</script>
</body>
</html>
