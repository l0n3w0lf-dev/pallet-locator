<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pallet Locator</title>

<style>
  :root{
    --bg:#f4f6f8;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow:0 12px 28px rgba(17,24,39,.08);
    --accent:#2563eb;
    --accentBg:#eef2ff;
    --danger:#b91c1c;
    --dangerBg:#fef2f2;
    --warn:#92400e;
    --warnBg:#fffbeb;
    --radius:16px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  .wrap{max-width:980px;margin:40px auto;padding:0 18px}
  header{display:flex;justify-content:space-between;gap:16px;align-items:flex-start;margin-bottom:16px}
  h1{margin:0;font-size:28px;font-weight:750;letter-spacing:.2px}
  .sub{margin:6px 0 0;color:var(--muted);line-height:1.45;max-width:70ch}

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border:1px solid var(--border);border-radius:999px;
    background:rgba(255,255,255,.75);
    box-shadow:0 8px 18px rgba(17,24,39,.06);
    font-size:13px;color:var(--muted);
    white-space:nowrap;
  }
  .dot{width:9px;height:9px;border-radius:50%}
  .dot.ok{background:#16a34a}
  .dot.bad{background:#dc2626}
  .dot.wait{background:#9ca3af}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  .controls{
    padding:16px;
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
  }

  .searchWrap{flex:1 1 420px;min-width:240px;position:relative}
  input{
    width:100%;
    padding:12px 14px;
    font-size:16px;
    border-radius:12px;
    border:1px solid #d1d5db;
    outline:none;
    background:#fff;
    transition:border-color .15s ease, box-shadow .15s ease;
  }
  input:focus{
    border-color:#c7d2fe;
    box-shadow:0 0 0 4px rgba(37,99,235,.12);
  }

  button{
    padding:12px 14px;
    border-radius:12px;
    border:1px solid #d1d5db;
    background:#fff;
    font-weight:650;
    cursor:pointer;
  }
  button:hover{background:#fafafa}
  button.primary{
    background:var(--accent);
    border-color:var(--accent);
    color:#fff;
  }
  button.primary:hover{filter:brightness(.98)}
  button:disabled{opacity:.55;cursor:not-allowed}

  .meta{
    padding:0 16px 10px;
    color:var(--muted);
    font-size:13px;
  }

  .notice{
    margin:0 16px 12px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fafafa;
    color:#4b5563;
    line-height:1.4;
  }
  .notice.warn{border-color:#fde68a;background:var(--warnBg);color:#7c2d12}
  .notice.danger{border-color:#fecaca;background:var(--dangerBg);color:#7f1d1d}

  .results{padding:0 16px 18px}
  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }
  @media (min-width: 860px){
    .grid{grid-template-columns:1fr 1fr;}
  }

  .item{
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    background:#fff;
  }
  .top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom:6px}
  .pallet{font-weight:800;font-size:15px;word-break:break-word}
  .pill{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--accentBg);
    color:#1e40af;
    white-space:nowrap;
  }
  .pill.dup{
    background:var(--dangerBg);
    border-color:#fecaca;
    color:#991b1b;
  }
  .meta2{color:var(--muted);font-size:13px;display:flex;flex-wrap:wrap;gap:10px 16px;line-height:1.35}
  .meta2 b{color:#111827}

  footer{text-align:center;margin-top:18px;color:#9ca3af;font-size:13px}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Pallet Locator</h1>
      <div class="sub">Type a pallet and results update <b>5 seconds after you stop typing</b>. (No auto sheet refresh.)</div>
    </div>
    <div class="chip">
      <span class="dot wait" id="dot"></span>
      <span id="status">Not loaded</span>
    </div>
  </header>

  <div class="card">
    <div class="controls">
      <div class="searchWrap">
        <input id="q" placeholder="Enter pallet ID/name…" autocomplete="off" />
      </div>
      <button id="loadBtn" type="button">Load data</button>
      <button id="refreshBtn" class="primary" type="button" disabled>Refresh search</button>
    </div>

    <div class="meta" id="meta">Rows: —</div>
    <div class="notice" id="notice">Click <b>Load data</b> first.</div>

    <div class="results">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <footer>Made by rozimnic.</footer>
</div>

<script>
  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRx6iH6_NCeeLOFF_FqLqMf-OPW2WqNpwV19Ti_xLA-RcHyKkYaQk4X0Xz1CJ8JvA/pub?output=csv";

  const SEARCH_DELAY_MS = 5000; // wait 5 seconds after typing stops
  const MAX_SHOW = 300;         // handles 50+ easily

  // DOM
  const dot = document.getElementById("dot");
  const statusEl = document.getElementById("status");
  const metaEl = document.getElementById("meta");
  const noticeEl = document.getElementById("notice");
  const gridEl = document.getElementById("grid");
  const inputEl = document.getElementById("q");
  const loadBtn = document.getElementById("loadBtn");
  const refreshBtn = document.getElementById("refreshBtn");

  // Data
  let headers = [];
  let rows = [];
  let loaded = false;
  let typingTimer = null;

  function setStatus(kind, text){
    statusEl.textContent = text;
    dot.className = "dot " + (kind || "wait");
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // Proper CSV parser (handles commas + quotes + empty cells)
  function parseCSV(text){
    const out = [];
    let row = [], cur = "", inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const c = text[i], n = text[i+1];

      if (c === '"' && inQuotes && n === '"'){ cur += '"'; i++; continue; }
      if (c === '"'){ inQuotes = !inQuotes; continue; }

      if (c === "," && !inQuotes){ row.push(cur); cur=""; continue; }

      if ((c === "\n" || c === "\r") && !inQuotes){
        if (c === "\r" && n === "\n") i++;
        row.push(cur); cur="";
        if (row.some(cell => cell.trim() !== "")) out.push(row);
        row = [];
        continue;
      }
      cur += c;
    }
    row.push(cur);
    if (row.some(cell => cell.trim() !== "")) out.push(row);

    return out;
  }

  function normalize(s){ return (s ?? "").toString().trim(); }

  async function loadData(){
    setStatus("wait", "Loading…");
    noticeEl.className = "notice";
    noticeEl.textContent = "Loading data from sheet…";

    const res = await fetch(CSV_URL, { cache:"no-store" });
    if (!res.ok) throw new Error(`Fetch failed (${res.status})`);

    const csv = await res.text();
    const grid = parseCSV(csv);

    headers = (grid[0] || []).map(h => normalize(h));
    rows = grid.slice(1);

    loaded = true;
    refreshBtn.disabled = false;

    metaEl.textContent = `Rows: ${rows.length.toLocaleString()}`;
    setStatus("ok", "Loaded");
    noticeEl.className = "notice";
    noticeEl.innerHTML = `Loaded. Start typing — results refresh after <b>5 seconds</b>.`;
  }

  function findMatches(query){
    const q = normalize(query).toLowerCase();
    if (!q) return [];

    const matches = [];
    for (let r = 0; r < rows.length; r++){
      const row = rows[r];
      for (let c = 0; c < headers.length; c++){
        const cell = normalize(row[c]);
        if (!cell) continue;
        if (cell.toLowerCase().includes(q)){
          matches.push({
            pallet: cell,
            location: headers[c] || `Column ${c+1}`,
            rowNumber: r + 2
          });
        }
      }
    }
    return matches;
  }

  function getDupCounts(matches){
    const map = new Map();
    for (const m of matches){
      const key = m.pallet.toLowerCase();
      map.set(key, (map.get(key) || 0) + 1);
    }
    return map;
  }

  function renderNow(){
    if (!loaded){
      noticeEl.className = "notice";
      noticeEl.innerHTML = "Click <b>Load data</b> first.";
      return;
    }

    const q = normalize(inputEl.value);
    if (!q){
      noticeEl.className = "notice";
      noticeEl.innerHTML = `Type a pallet. Results refresh after <b>5 seconds</b>.`;
      return;
    }

    const matches = findMatches(q);
    const dups = getDupCounts(matches);
    const hasDup = [...dups.values()].some(v => v > 1);

    gridEl.innerHTML = "";

    if (matches.length === 0){
      noticeEl.className = "notice";
      noticeEl.innerHTML = `<b>No match</b> for “${escapeHtml(q)}”.`;
      return;
    }

    noticeEl.className = hasDup ? "notice danger" : "notice warn";
    noticeEl.innerHTML = hasDup
      ? `<b>Duplicate detected.</b> Found ${matches.length} match(es) for “${escapeHtml(q)}”.`
      : `<b>${matches.length}</b> match(es) for “${escapeHtml(q)}”.`;

    // Sort duplicates first, then location, then row
    matches.sort((a,b)=>{
      const da = dups.get(a.pallet.toLowerCase()) || 0;
      const db = dups.get(b.pallet.toLowerCase()) || 0;
      if (da !== db) return db - da;
      if (a.location !== b.location) return a.location.localeCompare(b.location);
      return a.rowNumber - b.rowNumber;
    });

    const show = matches.slice(0, MAX_SHOW);

    for (const m of show){
      const dupN = dups.get(m.pallet.toLowerCase()) || 0;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="top">
          <div class="pallet">${escapeHtml(m.pallet)}</div>
          <div class="pill ${dupN > 1 ? "dup" : ""}">
            ${dupN > 1 ? `Duplicate (${dupN})` : "Match"}
          </div>
        </div>
        <div class="meta2">
          <span><b>Located in:</b> ${escapeHtml(m.location)}</span>
          <span><b>Sheet row:</b> ${m.rowNumber}</span>
        </div>
      `;
      gridEl.appendChild(el);
    }

    if (matches.length > MAX_SHOW){
      const more = document.createElement("div");
      more.className = "notice";
      more.textContent = `Showing first ${MAX_SHOW} results. Narrow your search to see fewer.`;
      gridEl.appendChild(more);
    }
  }

  function scheduleSearch(){
    if (!loaded) return;

    // Keep current results visible while typing; just update the notice
    noticeEl.className = "notice";
    noticeEl.innerHTML = `Typing… will refresh results in <b>5 seconds</b> after you stop.`;

    if (typingTimer) clearTimeout(typingTimer);
    typingTimer = setTimeout(renderNow, SEARCH_DELAY_MS);
  }

  // Events
  loadBtn.addEventListener("click", async () => {
    try{
      await loadData();
    }catch(e){
      setStatus("bad", "Load failed");
      noticeEl.className = "notice danger";
      noticeEl.innerHTML = `<b>Error:</b> ${escapeHtml(e.message)}<br>
        Tip: open this page via <b>http://localhost</b> (VS Code Live Server).`;
    }
  });

  inputEl.addEventListener("input", scheduleSearch);

  refreshBtn.addEventListener("click", () => {
    if (typingTimer) clearTimeout(typingTimer);
    renderNow();
  });

  // Init
  setStatus("wait", "Not loaded");
</script>
</body>
</html>
